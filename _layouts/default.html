<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title | default: site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">

    <!-- Prism.js - Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>

<body>
    <div class="wrapper">
        <header>
            <h1><a href="{{ '/' | relative_url }}">{{ site.title }}</a></h1>
            <p>{{ site.description }}</p>
        </header>

        <section>
            {{ content }}
        </section>

        <footer>
            <p><small>{{ site.title }} &copy; {{ 'now' | date: '%Y' }}</small></p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Mermaid.js for Diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        mermaid.initialize({
            startOnLoad: false,
            theme: 'neutral'
        });

        document.addEventListener('DOMContentLoaded', async () => {
            function getMermaidContent(el) {
                const txt = el.textContent || el.innerText;
                const textarea = document.createElement('textarea');
                textarea.innerHTML = txt;
                return textarea.value;
            }

            const selectors = [
                'pre > code.language-mermaid',
                '.language-mermaid pre > code',
                '.mermaid'
            ];

            const nodes = document.querySelectorAll(selectors.join(', '));

            for (const node of nodes) {
                if (node.tagName === 'DIV' && node.classList.contains('mermaid')) continue;
                if (node.getAttribute('data-processed')) continue;

                const graphDefinition = getMermaidContent(node);

                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = graphDefinition;

                let targetToReplace = node;
                if (node.tagName === 'CODE' && node.parentElement.tagName === 'PRE') {
                    targetToReplace = node.parentElement;
                    if (targetToReplace.parentElement.classList.contains('highlight') ||
                        targetToReplace.parentElement.className.includes('language-mermaid')) {
                        targetToReplace = targetToReplace.parentElement;
                        if (targetToReplace.parentElement.className.includes('highlighter-rouge')) {
                            targetToReplace = targetToReplace.parentElement;
                        }
                    }
                }

                targetToReplace.replaceWith(div);
            }

            await mermaid.run({
                querySelector: '.mermaid'
            });
        });
    </script>
</body>

</html>