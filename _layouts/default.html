<!doctype html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ page.title | default: site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">
    {% seo %}
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    {% if page.head %}
      {{ page.head }}
    {% endif %}
  </head>
  <body>
    <main class="page" role="main">
      {{ content }}
    </main>
    <div
      class="commit-egg"
      aria-hidden="true"
      data-hash="{{ site.github.build_revision | default: 'local-dev' }}"
      title="Build {{ site.github.build_revision | default: 'local-dev' }}"
    ></div>
    <script>
      window.IMAGE_FALLBACK_SRC = "{{ '/assets/images/image-unavailable.svg' | relative_url }}";
    </script>
    <script src="{{ '/assets/js/image-fallback.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/share.js' | relative_url }}"></script>
    <script type="module">
      document.addEventListener('DOMContentLoaded', async () => {
        const selectors = [
          'pre > code.language-mermaid',
          '.language-mermaid pre > code',
          '.mermaid'
        ];
        const nodes = document.querySelectorAll(selectors.join(', '));
        if (!nodes.length) return;

        const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs');
        mermaid.initialize({ startOnLoad: false });

        for (const node of nodes) {
          if (node.tagName === 'DIV' && node.classList.contains('mermaid')) continue;
          if (node.getAttribute('data-processed')) continue;

          const txt = node.textContent || node.innerText || '';
          const textarea = document.createElement('textarea');
          textarea.innerHTML = txt;
          const graphDefinition = textarea.value;

          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = graphDefinition;

          let targetToReplace = node;
          if (node.tagName === 'CODE' && node.parentElement?.tagName === 'PRE') {
            targetToReplace = node.parentElement;
            if (targetToReplace.parentElement?.classList.contains('highlight') ||
                targetToReplace.parentElement?.className.includes('language-mermaid')) {
              targetToReplace = targetToReplace.parentElement;
              if (targetToReplace.parentElement?.className.includes('highlighter-rouge')) {
                targetToReplace = targetToReplace.parentElement;
              }
            }
          }

          targetToReplace.replaceWith(div);
        }

        await mermaid.run({ querySelector: '.mermaid' });
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('pre').forEach((pre) => {
          const code = pre.querySelector('code');
          if (!code || pre.classList.contains('mermaid')) return;

          const button = document.createElement('button');
          button.className = 'copy-button';
          button.type = 'button';
          button.innerText = 'Copy';

          pre.style.position = 'relative';
          pre.appendChild(button);

          button.addEventListener('click', () => {
            navigator.clipboard.writeText(code.innerText).then(() => {
              button.innerText = 'Copied!';
              button.classList.add('copied');
              setTimeout(() => {
                button.innerText = 'Copy';
                button.classList.remove('copied');
              }, 2000);
            });
          });
        });
      });
    </script>
  </body>
</html>
